{{ define "main" }}
<div class="search-page">
    <header class="search-header">
        <h1 class="search-title">검색</h1>
        <div class="search-box">
            <input type="search" id="search-input" placeholder="검색어를 입력하세요..." class="search-input-main" autofocus>
            <button type="button" id="search-btn" class="search-btn-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </button>
        </div>
    </header>

    <div id="search-results"></div>
</div>

<script>
(function() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchResults = document.getElementById('search-results');
    let searchIndex = null;

    // Load search index
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            searchIndex = data;
        })
        .catch(error => {
            console.error('Failed to load search index:', error);
        });

    // Get query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        searchInput.value = query;
        performSearch(query);
    }

    // Search on button click
    searchBtn.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query) {
            performSearch(query);
            history.pushState(null, null, '?q=' + encodeURIComponent(query));
        }
    });

    // Search on Enter key
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            if (query) {
                performSearch(query);
                history.pushState(null, null, '?q=' + encodeURIComponent(query));
            }
        }
    });

    function performSearch(query) {
        if (!searchIndex) {
            searchResults.innerHTML = '<p class="search-message">검색 인덱스를 로드하는 중...</p>';
            return;
        }

        const lowerQuery = query.toLowerCase();
        const results = searchIndex.filter(item => {
            const titleMatch = item.title.toLowerCase().includes(lowerQuery);
            const contentMatch = item.content.toLowerCase().includes(lowerQuery);
            const tagsMatch = item.tags && item.tags.some(tag => tag.toLowerCase().includes(lowerQuery));
            return titleMatch || contentMatch || tagsMatch;
        });

        if (results.length === 0) {
            searchResults.innerHTML = '<p class="search-message">검색 결과가 없습니다.</p>';
            return;
        }

        let html = '<div class="search-results-list">';
        html += '<p class="search-count">' + results.length + '개의 검색 결과</p>';

        results.forEach(item => {
            const contentPreview = getContentPreview(item.content, lowerQuery);

            html += '<article class="search-result-item">';
            html += '<h2 class="search-result-title"><a href="' + item.permalink + '">' + highlightText(item.title, query) + '</a></h2>';
            html += '<div class="search-result-meta">';
            html += '<time>' + formatDate(item.date) + '</time>';
            if (item.categories && item.categories.length > 0) {
                html += '<span class="separator">·</span>';
                html += '<span class="categories">' + item.categories.join(', ') + '</span>';
            }
            html += '</div>';
            html += '<p class="search-result-content">' + highlightText(contentPreview, query) + '</p>';
            html += '</article>';
        });

        html += '</div>';
        searchResults.innerHTML = html;
    }

    function getContentPreview(content, query) {
        const maxLength = 200;
        const index = content.toLowerCase().indexOf(query);

        if (index === -1) {
            return content.substring(0, maxLength) + (content.length > maxLength ? '...' : '');
        }

        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 150);
        let preview = content.substring(start, end);

        if (start > 0) preview = '...' + preview;
        if (end < content.length) preview = preview + '...';

        return preview;
    }

    function highlightText(text, query) {
        const regex = new RegExp('(' + escapeRegex(query) + ')', 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }
})();
</script>
{{ end }}
